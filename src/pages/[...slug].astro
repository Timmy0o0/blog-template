---
import type { Metadata } from "@interface/data";
import BaseLayout from "@layouts/BaseLayout.astro";
import BlogPostLayout from "@layouts/BlogPostLayout.astro";
import { sortPostsByOrder } from "@utils/blog-utils";
import { getCollection, render, type CollectionEntry } from "astro:content";

interface Props {
  post: CollectionEntry<"blog">;
  prevPost?: CollectionEntry<"blog">;
  nextPost?: CollectionEntry<"blog">;
}

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  // Sort by order field, smaller numbers first
  const sortedPosts = sortPostsByOrder(posts);

  return sortedPosts.map((post, index) => {
    const prevPost = index > 0 ? sortedPosts[index - 1] : undefined;
    const nextPost =
      index < sortedPosts.length - 1 ? sortedPosts[index + 1] : undefined;

    return {
      params: { slug: post.id },
      props: { post, prevPost, nextPost },
    };
  });
}

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await render(post);

const metadata: Metadata = {
  title: post.data.title,
  description: post.data.description,
  image: post.data.image?.src,
  type: "article",
};
---

<BaseLayout metadata={metadata}>
  <BlogPostLayout
    post={post}
    headings={headings}
    prevPost={prevPost}
    nextPost={nextPost}
  >
    <Content />
  </BlogPostLayout>
</BaseLayout>
